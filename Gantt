<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma CLARION - Optimizado (Fast Track)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; padding: 20px; }
        .gantt-container { background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 20px; overflow-x: auto; }
        .gantt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
        
        svg { display: block; }
        .grid-line { stroke: #f1f5f9; stroke-width: 1; }
        .grid-line-weekend { fill: #f8fafc; }
        .row-separator { stroke: #e2e8f0; stroke-width: 1; }
        .day-label { font-size: 10px; fill: #94a3b8; text-anchor: middle; }
        .month-label { font-size: 12px; font-weight: bold; fill: #334155; }
        
        /* Estilos de Tareas */
        .task-bar { rx: 3; ry: 3; transition: opacity 0.3s; cursor: pointer; stroke: white; stroke-width: 1; }
        .task-bar:hover { opacity: 0.9; filter: brightness(1.1); }

        /* Margen de Tarea individual */
        .task-margin { rx: 3; ry: 3; fill: url(#diagonalHatch); stroke: #cbd5e1; stroke-width: 1; opacity: 0.6; }
        
        /* Buffer del Proyecto (Ganancia por eficiencia) */
        .project-buffer { rx: 3; ry: 3; fill: url(#successHatch); stroke: #86efac; stroke-width: 1; opacity: 0.8; }

        .critical-task { stroke: #ef4444; stroke-width: 2; }
        .parallel-indicator { font-size: 10px; fill: #64748b; font-style: italic; }

        .task-text { font-size: 11px; fill: #1e293b; font-weight: 500; dominant-baseline: middle; }

        .dependency-line { stroke: #94a3b8; stroke-width: 1.5; fill: none; marker-end: url(#arrow); opacity: 0.5; }
        
        #tooltip { position: absolute; background: #0f172a; color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.1s; z-index: 100; max-width: 300px; line-height: 1.4; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .fill-b1 { fill: #3b82f6; } .fill-b2 { fill: #8b5cf6; } .fill-b3 { fill: #10b981; }
        .fill-b4 { fill: #f59e0b; } .fill-b5 { fill: #ef4444; } .fill-b6 { fill: #06b6d4; }
        .fill-b7 { fill: #ec4899; } .fill-b8 { fill: #6366f1; }
    </style>
</head>
<body>

<div class="max-w-full mx-auto">
    <div class="gantt-header">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Cronograma Optimizado (Fast-Track)</h1>
            <p class="text-sm text-slate-500 mt-1">
                Estrategia de Paralelismo | Inicio: <strong>01 Nov</strong> — Entrega: <strong>03 Dic</strong>
            </p>
        </div>
        <div class="text-right flex flex-col items-end gap-1 text-xs text-slate-600">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-blue-500 rounded"></div> <span>Tarea (80% Tiempo)</span>
                <div class="w-3 h-3 border border-slate-400 rounded" style="background: repeating-linear-gradient(45deg, #e2e8f0, #e2e8f0 2px, #fff 2px, #fff 4px);"></div> <span>Margen Tarea (20%)</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 border border-green-400 rounded" style="background: repeating-linear-gradient(45deg, #dcfce7, #dcfce7 2px, #fff 2px, #fff 4px);"></div> <span class="font-bold text-green-700">Buffer de Proyecto (Ganado)</span>
            </div>
        </div>
    </div>

    <div class="gantt-container" id="chart-container"></div>
</div>

<div id="tooltip"></div>

<script>
    const START_DATE = new Date(2025, 10, 1); // 1 Nov
    const DEADLINE_DATE = new Date(2025, 11, 3); // 3 Dic
    
    function getDateFromDayOffset(offset) {
        const date = new Date(START_DATE);
        date.setDate(date.getDate() + offset);
        return date;
    }
    function formatDate(date) { return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }); }

    // --- TAREAS OPTIMIZADAS (PARALELISMO) ---
    // Se han ajustado las dependencias (dep) para permitir ejecución simultánea
    const tasks = [
        // B1: Definición (Paralelo)
        { id: "2.1", name: "Definición de Necesidad (Sec 2.1)", duration: 2, block: 1, dep: [] },
        { id: "2.2", name: "Marco de Actores (Sec 2.2)", duration: 2, block: 1, dep: ["2.1"] }, 
        { id: "2.3-6", name: "Metas, Objetivos y Misión (Sec 2.3-2.6)", duration: 2, block: 1, dep: ["2.1"] }, // Paralelo a 2.2

        // B2: Ops
        { id: "2.7-8", name: "Restricciones y Autoridades", duration: 2, block: 2, dep: ["2.2", "2.3-6"] },
        { id: "2.9", name: "Concepto de Operaciones (ConOps)", duration: 3, block: 2, dep: ["2.7-8"] },

        // B3: Arquitectura (Paralelo)
        { id: "3.1", name: "Matriz N2 e Interfaces (Sec 3.1)", duration: 2, block: 3, dep: ["2.9"] },
        { id: "3.2", name: "Bloques Funcionales (Sec 3.2)", duration: 2, block: 3, dep: ["2.9"] }, // Paralelo a 3.1
        { id: "3.3", name: "Diagrama de Subsistemas (Sec 3.3)", duration: 2, block: 3, dep: ["3.1", "3.2"] },

        // B4 & B5: Análisis Simultáneo (Gran ganancia de tiempo)
        { id: "4.0", name: "Análisis de Ambiente (Sec 4)", duration: 3, block: 4, dep: ["3.3"] },
        { id: "5.0", name: "Requerimientos (Sec 5)", duration: 4, block: 5, dep: ["3.3"] }, // Paralelo a 4.0

        // B6: Planificación Simultánea
        { id: "6.1-2", name: "WBS y Cronograma", duration: 2, block: 6, dep: ["5.0"] },
        { id: "6.3-5", name: "Matriz y Análisis de Riesgos", duration: 3, block: 6, dep: ["5.0", "4.0"] }, // Paralelo a 6.1-2

        // B7: Cierre
        { id: "7-8", name: "Conclusiones y Bibliografía", duration: 1, block: 7, dep: ["6.1-2", "6.3-5"] },
        { id: "REV", name: "Revisión y Formato Final", duration: 3, block: 7, dep: ["7-8"] },
        
        // Hito Final (Se alinea a la fecha real de finalización técnica)
        { id: "MCR", name: "ENTREGA FINAL (HITO)", duration: 0, block: 8, dep: ["REV"] } 
    ];

    // --- CPM CALCULATION ---
    const calculateSchedule = (tasks) => {
        const map = {}; tasks.forEach(t => map[t.id] = t);
        const forward = {};
        
        const getES = (id) => {
            if(forward[id]) return forward[id].ES;
            const t = map[id];
            let maxEF = 0;
            if(t.dep.length > 0) {
                t.dep.forEach(dId => {
                    const dEF = getES(dId) + map[dId].duration;
                    if(dEF > maxEF) maxEF = dEF;
                });
            }
            forward[id] = { ES: maxEF, EF: maxEF + t.duration };
            return maxEF;
        };
        tasks.forEach(t => getES(t.id));

        let PD = 0; // Project Duration (Técnica)
        Object.values(forward).forEach(f => { if(f.EF > PD) PD = f.EF; });

        // Calculate Buffer
        // Fecha fin técnica vs Fecha fin real (3 Dic)
        // 1 Nov a 3 Dic son 33 días (aprox). 
        const deadlineDayOffset = 32; // 0-indexed, día 32 es el 3 de Dic.
        
        const schedule = {};
        tasks.forEach(t => {
            const f = forward[t.id];
            // Slack calculado contra la duración técnica del proyecto, no el deadline duro aun
            // para mostrar ruta crítica técnica.
            schedule[t.id] = { ...f, LS: 0, LF: 0, S: 0, isCritical: false };
        });

        // Backward pass using Technical PD
        for(let i=tasks.length-1; i>=0; i--){
            const t = tasks[i];
            const s = schedule[t.id];
            const succ = tasks.filter(x => x.dep.includes(t.id));
            let minLS = PD;
            if(succ.length > 0) succ.forEach(sc => { if(schedule[sc.id].LS < minLS) minLS = schedule[sc.id].LS; });
            s.LF = minLS;
            s.LS = s.LF - t.duration;
            s.S = s.LF - s.EF;
            s.isCritical = s.S === 0;
        }
        
        return { schedule, PD, deadlineDayOffset };
    };

    const { schedule, PD, deadlineDayOffset } = calculateSchedule(tasks);
    // Max days para el SVG es hasta el deadline (para mostrar el buffer)
    const maxDays = Math.max(PD, deadlineDayOffset) + 2;

    // --- RENDER ---
    const dayWidth = 30; 
    const rowHeight = 36;
    const headerHeight = 50;
    const leftPadding = 280;
    const svgWidth = leftPadding + (maxDays * dayWidth);
    const svgHeight = headerHeight + (tasks.length * rowHeight) + 60; // Extra space for buffer visualization

    let svg = `<svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <marker id="arrow" markerWidth="5" markerHeight="5" refX="5" refY="2.5" orient="auto"><path d="M0,0 L5,2.5 L0,5" fill="#94a3b8" /></marker>
            <pattern id="diagonalHatch" width="4" height="4" patternTransform="rotate(45 0 0)" patternUnits="userSpaceOnUse"><line x1="0" y1="0" x2="0" y2="4" style="stroke:#cbd5e1; stroke-width:1" /></pattern>
            <pattern id="successHatch" width="4" height="4" patternTransform="rotate(-45 0 0)" patternUnits="userSpaceOnUse"><line x1="0" y1="0" x2="0" y2="4" style="stroke:#86efac; stroke-width:1" /></pattern>
        </defs>
        <rect width="100%" height="100%" fill="white" />`;

    // Grid
    let currMonth = -1;
    for(let d=0; d<maxDays; d++){
        const date = getDateFromDayOffset(d);
        const x = leftPadding + (d*dayWidth);
        const isWE = (date.getDay()===0 || date.getDay()===6);
        if(isWE) svg += `<rect x="${x}" y="${headerHeight}" width="${dayWidth}" height="${svgHeight}" class="grid-line-weekend" />`;
        svg += `<line x1="${x}" y1="${headerHeight}" x2="${x}" y2="${svgHeight}" class="grid-line" />`;
        
        // Deadline Line
        if(d === deadlineDayOffset) {
             svg += `<line x1="${x}" y1="${0}" x2="${x}" y2="${svgHeight}" stroke="#ef4444" stroke-width="2" stroke-dasharray="5,5" />`;
             svg += `<text x="${x+5}" y="${headerHeight-25}" fill="#ef4444" font-size="10" font-weight="bold">DEADLINE</text>`;
        }

        if(d % 2 === 0) svg += `<text x="${x + dayWidth/2}" y="${headerHeight-5}" class="day-label">${date.getDate()}</text>`;
        
        if(date.getMonth() !== currMonth){
            svg += `<text x="${x+5}" y="20" class="month-label">${date.toLocaleString('es-ES',{month:'long'}).toUpperCase()}</text>`;
            svg += `<line x1="${x}" y1="0" x2="${x}" y2="${headerHeight}" stroke="#cbd5e1" stroke-width="1" />`;
            currMonth = date.getMonth();
        }
    }

    let y = headerHeight;
    let connHTML = "";
    let barHTML = "";
    let txtHTML = "";
    let blkHTML = "";
    let currBlk = 0;

    tasks.forEach((t, i) => {
        const s = schedule[t.id];
        const x = leftPadding + (s.ES * dayWidth);
        
        // 80/20 Split
        const fullW = t.duration * dayWidth;
        const workW = fullW * 0.8;
        const margW = fullW * 0.2;
        
        svg += `<line x1="0" y1="${y}" x2="${svgWidth}" y2="${y}" class="row-separator" />`;

        // Block Color
        if(t.block !== currBlk){
            const h = tasks.filter(x=>x.block===t.block).length * rowHeight;
            blkHTML += `<rect x="0" y="${y}" width="5" height="${h}" class="fill-b${t.block}" />`;
            currBlk = t.block;
        }
        
        // Text
        const isParallel = (t.id === "2.3-6" || t.id === "3.2" || t.id === "5.0" || t.id === "6.3-5");
        const label = isParallel ? `${t.name} (Simultáneo)` : t.name;
        txtHTML += `<text x="15" y="${y + rowHeight/2}" class="task-text" style="${isParallel?'fill:#475569':''}">${label}</text>`;

        if(t.duration > 0) {
            // Work Bar
            const d1 = (t.duration*0.8).toFixed(1);
            const d2 = (t.duration*0.2).toFixed(1);
            const tip1 = `<strong>${t.name}</strong><br>Ejecución: ${d1} días<br>Inicio: ${formatDate(getDateFromDayOffset(s.ES))}`;
            
            barHTML += `<rect x="${x}" y="${y+8}" width="${workW}" height="${rowHeight-16}" class="task-bar fill-b${t.block} ${s.isCritical?'critical-task':''}" onmouseover="showTooltip(evt, '${tip1}')" onmouseout="hideTooltip()" />`;
            
            // Margin Bar
            barHTML += `<rect x="${x+workW}" y="${y+8}" width="${margW}" height="${rowHeight-16}" class="task-margin" onmouseover="showTooltip(evt, 'Margen Tarea: ${d2} días')" onmouseout="hideTooltip()" />`;
        } else {
            // Milestone Diamond
             barHTML += `<path d="M${x},${y+8} L${x+10},${y+18} L${x},${y+28} L${x-10},${y+18} Z" fill="#ef4444" />`;
        }

        // Dependencies
        t.dep.forEach(dp => {
            const pix = tasks.findIndex(x=>x.id===dp);
            if(pix >= 0){
                const ps = schedule[dp];
                const x1 = leftPadding + (ps.EF * dayWidth);
                const y1 = headerHeight + (pix * rowHeight) + rowHeight/2;
                const x2 = x;
                const y2 = y + rowHeight/2;
                
                let p = "";
                if(x2 > x1 + 10) p = `M${x1},${y1} L${x2-5},${y1} L${x2-5},${y2} L${x2},${y2}`;
                else p = `M${x1},${y1} L${x1+5},${y1} L${x1+5},${y2-5} L${x2-5},${y2-5} L${x2-5},${y2} L${x2},${y2}`;
                
                connHTML += `<path d="${p}" class="dependency-line" />`;
            }
        });

        y += rowHeight;
    });

    // --- PROJECT BUFFER VISUALIZATION ---
    // Mostrar la holgura ganada al final
    const techFinishX = leftPadding + (PD * dayWidth);
    const deadFinishX = leftPadding + (deadlineDayOffset * dayWidth);
    const bufferWidth = deadFinishX - techFinishX;
    
    if(bufferWidth > 0) {
        // Dibujar una barra de "Buffer" en la última fila (Hito MCR) o una nueva fila
        const bufferY = y - rowHeight + 8; // Al nivel del hito
        //barHTML += `<rect x="${techFinishX}" y="${bufferY}" width="${bufferWidth}" height="${rowHeight-16}" class="project-buffer" onmouseover="showTooltip(evt, '<strong>Buffer de Proyecto</strong><br>Ganado por eficiencia.<br>Seguridad extra antes del MCR.')" onmouseout="hideTooltip()" />`;
        
        // O mejor, una zona sombreada vertical al final que muestre el tiempo ganado
        // svg += `<rect x="${techFinishX}" y="${headerHeight}" width="${bufferWidth}" height="${svgHeight - headerHeight}" fill="#dcfce7" opacity="0.3" />`;
        // svg += `<text x="${techFinishX + 10}" y="${svgHeight - 10}" font-size="11" fill="#15803d" font-weight="bold">Buffer de Seguridad (${(bufferWidth/dayWidth).toFixed(0)} días)</text>`;
    }

    svg += blkHTML + connHTML + barHTML + txtHTML + `</svg>`;
    document.getElementById('chart-container').innerHTML = svg;

    // Tooltip
    const tt = document.getElementById('tooltip');
    window.showTooltip = (e,t) => { tt.innerHTML=t; tt.style.opacity=1; tt.style.left=(e.pageX+15)+'px'; tt.style.top=(e.pageY+10)+'px'; }
    window.hideTooltip = () => { tt.style.opacity=0; }

</script>
</body>
</html>
