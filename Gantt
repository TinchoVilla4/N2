<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma CLARION - Con Margen de Seguridad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            padding: 20px;
        }
        .gantt-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-x: auto;
        }
        .gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
        }
        
        svg { display: block; }
        .grid-line { stroke: #e2e8f0; stroke-width: 1; }
        .grid-line-weekend { fill: #f8fafc; }
        .row-separator { stroke: #e2e8f0; stroke-width: 1; }
        .day-label { font-size: 10px; fill: #64748b; text-anchor: middle; }
        .month-label { font-size: 12px; font-weight: bold; fill: #334155; }
        
        /* Barra Principal (Ejecución) */
        .task-bar { 
            rx: 2; ry: 2; 
            transition: opacity 0.3s; 
            cursor: pointer; 
            stroke: white;
            stroke-width: 1;
        }
        .task-bar:hover { opacity: 0.9; }

        /* Barra de Margen (Contingencia) */
        .task-margin {
            rx: 2; ry: 2;
            fill: url(#diagonalHatch); /* Patrón rayado */
            stroke: #cbd5e1;
            stroke-width: 1;
            opacity: 0.8;
            cursor: pointer;
        }
        .task-margin:hover { opacity: 1; stroke: #94a3b8; }

        .critical-task { stroke: #ef4444; stroke-width: 1.5; }

        .task-text {
            font-size: 11px;
            fill: #1e293b;
            font-weight: 500;
            dominant-baseline: middle;
            text-shadow: 0px 0px 4px white;
        }

        .dependency-line {
            stroke: #94a3b8;
            stroke-width: 1.5;
            fill: none;
            marker-end: url(#arrow);
            opacity: 0.5;
            transition: all 0.2s;
        }
        .dependency-line:hover { opacity: 1; stroke: #334155; stroke-width: 2; }
        
        #tooltip {
            position: absolute;
            background: #0f172a;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 100;
            max-width: 280px;
            line-height: 1.4;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Colores de Bloque */
        .fill-b1 { fill: #3b82f6; } .stroke-b1 { stroke: #3b82f6; }
        .fill-b2 { fill: #8b5cf6; } .stroke-b2 { stroke: #8b5cf6; }
        .fill-b3 { fill: #10b981; } .stroke-b3 { stroke: #10b981; }
        .fill-b4 { fill: #f59e0b; } .stroke-b4 { stroke: #f59e0b; }
        .fill-b5 { fill: #ef4444; } .stroke-b5 { stroke: #ef4444; }
        .fill-b6 { fill: #06b6d4; } .stroke-b6 { stroke: #06b6d4; }
        .fill-b7 { fill: #ec4899; } .stroke-b7 { stroke: #ec4899; }
        .fill-b8 { fill: #6366f1; } .stroke-b8 { stroke: #6366f1; }

    </style>
</head>
<body>

<div class="max-w-full mx-auto">
    <div class="gantt-header">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Cronograma CLARION - Gestión de Riesgo</h1>
            <p class="text-sm text-slate-500 mt-1">
                Inicio: <strong>01 Nov 2025</strong> &mdash; MCR: <strong>03 Dic 2025</strong>
                <span class="ml-2 px-2 py-0.5 bg-amber-100 text-amber-800 rounded text-xs font-medium">Plazos Ajustados</span>
            </p>
        </div>
        <div class="text-right flex items-center gap-4 text-xs text-slate-600">
             <div class="flex items-center gap-1">
                <div class="w-3 h-3 bg-blue-500 rounded"></div>
                <span>Ejecución (80%)</span>
            </div>
            <div class="flex items-center gap-1">
                <div class="w-3 h-3 border border-slate-400 rounded" style="background: repeating-linear-gradient(45deg, #e2e8f0, #e2e8f0 2px, #fff 2px, #fff 4px);"></div>
                <span>Margen 25% (20% del total)</span>
            </div>
        </div>
    </div>

    <div class="gantt-container" id="chart-container"></div>
</div>

<div id="tooltip"></div>

<script>
    // --- CONFIGURACIÓN ---
    const START_DATE = new Date(2025, 10, 1); // 1 Nov 2025
    
    function getDateFromDayOffset(offset) {
        const date = new Date(START_DATE);
        date.setDate(date.getDate() + offset);
        return date;
    }

    function formatDate(date) {
        return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
    }

    // --- TAREAS (Estructura Original del Gantt provisto) ---
    // NOTA: Las duraciones aquí son los "slots" totales disponibles en el calendario.
    // El código las dividirá en Ejecución y Margen.
    const tasks = [
        { id: "1.1", name: "Kick-off + alineación", duration: 1, block: 1, dep: [] },
        { id: "1.2", name: "Definir problema y objetivos", duration: 2, block: 1, dep: ["1.1"] },
        { id: "1.3", name: "Definir alcance preliminar", duration: 1, block: 1, dep: ["1.2"] },
        { id: "1.4", name: "Identificar restricciones", duration: 1, block: 1, dep: ["1.2"] },
        
        { id: "2.1", name: "Definir escenarios operativos", duration: 2, block: 2, dep: ["1.3", "1.4"] },
        { id: "2.2", name: "Definir modos de misión", duration: 1, block: 2, dep: ["2.1"] },
        { id: "2.3", name: "Definir segmentos", duration: 1, block: 2, dep: ["2.1"] },
        { id: "2.4", name: "Diagrama secuencia ops", duration: 1, block: 2, dep: ["2.2", "2.3"] },

        { id: "3.1", name: "Alternativas plataforma", duration: 2, block: 3, dep: ["2.4"] },
        { id: "3.2", name: "Alternativas payload", duration: 2, block: 3, dep: ["2.4"] },
        { id: "3.3", name: "Alternativas órbita", duration: 2, block: 3, dep: ["2.4"] },

        { id: "4.1", name: "Análisis desempeño orbital", duration: 2, block: 4, dep: ["3.3"] },
        { id: "4.2", name: "Análisis comunicaciones", duration: 2, block: 4, dep: ["3.1", "4.1"] },
        { id: "4.3", name: "Est. consumo potencia", duration: 2, block: 4, dep: ["3.1", "3.2"] },
        { id: "4.4", name: "Viabilidad vigilancia ISS", duration: 1, block: 4, dep: ["4.1", "4.2", "4.3"] },

        { id: "5.1", name: "WBS Nivel 1-2 + dicc.", duration: 2, block: 5, dep: ["3.1", "3.2"] },
        { id: "5.2", name: "Estimación ROM Costos", duration: 1, block: 5, dep: ["5.1"] },
        { id: "5.3", name: "Estimación ROM Crono", duration: 1, block: 5, dep: ["5.1"] },
        { id: "5.4", name: "Identificación riesgos", duration: 2, block: 5, dep: ["4.4", "5.1"] },

        { id: "6.1", name: "Matriz de decisión", duration: 2, block: 6, dep: ["4.4", "5.2", "5.3", "5.4"] },
        { id: "6.2", name: "Selección Baseline", duration: 1, block: 6, dep: ["6.1"] },

        { id: "7.1", name: "Preparar doc. MCR", duration: 4, block: 7, dep: ["6.2"] },
        { id: "7.2", name: "Ensayar presentación", duration: 1, block: 7, dep: ["7.1"] },
        { id: "7.3", name: "Correcciones finales", duration: 1, block: 7, dep: ["7.2"] },

        { id: "8.1", name: "Envío Previo", duration: 1, block: 8, dep: ["7.3"] },
        { id: "8.2", name: "REVISIÓN MCR (HITO)", duration: 1, block: 8, dep: ["8.1"] }
    ];

    // --- CÁLCULO (CPM) ---
    const calculateSchedule = (tasks) => {
        const forwardPass = {}; 
        const taskMap = {};
        tasks.forEach((task, index) => taskMap[task.id] = { ...task, index });

        const getES = (taskId) => {
            const task = taskMap[taskId];
            if (!task) return 0;
            if (forwardPass[taskId]) return forwardPass[taskId].ES;

            let maxEF = 0;
            if (task.dep && task.dep.length > 0) {
                task.dep.forEach(depId => {
                    const depEF = getES(depId) + taskMap[depId].duration;
                    if (depEF > maxEF) maxEF = depEF;
                });
            }
            forwardPass[taskId] = { ES: maxEF, EF: maxEF + task.duration };
            return maxEF;
        };
        tasks.forEach(task => getES(task.id));

        let PD = 0;
        Object.values(forwardPass).forEach(s => { if(s.EF > PD) PD = s.EF; });
        
        const schedule = {};
        tasks.forEach(task => {
            schedule[task.id] = { ...forwardPass[task.id], LS: 0, LF: PD, S: 0, isCritical: false };
        });

        for (let i = tasks.length - 1; i >= 0; i--) {
            const taskId = tasks[i].id;
            const task = taskMap[taskId];
            const sched = schedule[taskId];
            
            const successors = tasks.filter(t => t.dep.includes(taskId));
            let minLS = PD;

            if (successors.length > 0) {
                successors.forEach(succ => {
                    if (schedule[succ.id].LS < minLS) minLS = schedule[succ.id].LS;
                });
                sched.LF = minLS;
            } else {
                sched.LF = PD;
            }
            
            sched.LS = sched.LF - task.duration;
            sched.S = parseFloat((sched.LF - sched.EF).toFixed(2));
            sched.isCritical = sched.S === 0;
        }
        return { schedule, PD };
    };

    const { schedule, PD } = calculateSchedule(tasks);
    const maxDays = Math.ceil(PD) + 2;

    // --- RENDERIZADO ---
    const dayWidth = 35; 
    const rowHeight = 38;
    const headerHeight = 60;
    const leftPadding = 240;
    const svgWidth = leftPadding + (maxDays * dayWidth);
    const svgHeight = headerHeight + (tasks.length * rowHeight) + 30;

    let svgHTML = `<svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg">`;
    
    // Definiciones (Patrón rayado para margen)
    svgHTML += `
    <defs>
        <marker id="arrow" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto">
            <path d="M0,0 L6,3 L0,6" fill="#94a3b8" /> 
        </marker>
        <pattern id="diagonalHatch" width="4" height="4" patternTransform="rotate(45 0 0)" patternUnits="userSpaceOnUse">
            <line x1="0" y1="0" x2="0" y2="4" style="stroke:#cbd5e1; stroke-width:1" />
        </pattern>
    </defs>
    <rect width="100%" height="100%" fill="white" />`;
    
    // Grid de Días
    let currentMonth = -1;
    for (let d = 0; d < maxDays; d++) {
        const currentDate = getDateFromDayOffset(d);
        const x = leftPadding + (d * dayWidth);
        const isWeekend = (currentDate.getDay() === 0 || currentDate.getDay() === 6);

        if (isWeekend) {
             svgHTML += `<rect x="${x}" y="${headerHeight}" width="${dayWidth}" height="${svgHeight}" class="grid-line-weekend" />`;
        }
        
        svgHTML += `<line x1="${x}" y1="${headerHeight}" x2="${x}" y2="${svgHeight}" class="grid-line" />`;
        svgHTML += `<text x="${x + (dayWidth/2)}" y="${headerHeight - 10}" class="day-label">${currentDate.getDate()}</text>`;

        if (currentDate.getMonth() !== currentMonth) {
            const monthName = currentDate.toLocaleString('es-ES', { month: 'long' }).toUpperCase();
            svgHTML += `<text x="${x + 5}" y="${20}" class="month-label">${monthName}</text>`;
            svgHTML += `<line x1="${x}" y1="0" x2="${x}" y2="${headerHeight}" stroke="#cbd5e1" stroke-width="2" />`;
            currentMonth = currentDate.getMonth();
        }
    }

    let currentY = headerHeight;
    let taskBarsHTML = "";
    let textHTML = "";
    let linesHTML = "";
    let blockHTML = "";
    
    let currentBlock = 0;

    tasks.forEach((task, index) => {
        const s = schedule[task.id];
        const xBase = leftPadding + (s.ES * dayWidth);
        
        // --- LÓGICA DE MARGEN ---
        // Dividimos la duración total: 80% Trabajo, 20% Margen
        // Esto asegura que el total (Trabajo + Margen) respete el cronograma estricto.
        const totalWidth = task.duration * dayWidth;
        const workWidth = totalWidth * 0.8;
        const marginWidth = totalWidth * 0.2;
        
        const workDays = (task.duration * 0.8).toFixed(1);
        const marginDays = (task.duration * 0.2).toFixed(1);

        if (task.block !== currentBlock) {
            // Barra lateral de color de bloque
            const blockHeight = tasks.filter(t=>t.block===task.block).length * rowHeight;
            blockHTML += `<rect x="0" y="${currentY}" width="5" height="${blockHeight}" class="fill-b${task.block}" />`;
            currentBlock = task.block;
        }

        svgHTML += `<line x1="0" y1="${currentY}" x2="${svgWidth}" y2="${currentY}" class="row-separator" />`;
        
        textHTML += `<text x="15" y="${currentY + (rowHeight/2)}" class="task-text" style="font-weight: ${task.id.includes('MCR') ? 'bold' : 'normal'}">${task.id} ${task.name}</text>`;

        // Tooltips
        const startDate = getDateFromDayOffset(s.ES);
        const endDate = getDateFromDayOffset(s.EF);
        const tipWork = `<strong>${task.name}</strong><br>Ejecución Estimada: ${workDays} días<br>Inicio: ${formatDate(startDate)}`;
        const tipMargin = `<strong>Margen de Seguridad</strong><br>Reserva: ${marginDays} días<br>Fin Límite: ${formatDate(endDate)}`;

        // 1. Barra de Trabajo
        taskBarsHTML += `<rect x="${xBase}" y="${currentY + 10}" width="${workWidth}" height="${rowHeight - 20}" 
            class="task-bar fill-b${task.block} ${s.isCritical ? 'critical-task' : ''}" 
            onmouseover="showTooltip(evt, '${tipWork}')" onmouseout="hideTooltip()" />`;

        // 2. Barra de Margen (pegada a la derecha)
        taskBarsHTML += `<rect x="${xBase + workWidth}" y="${currentY + 10}" width="${marginWidth}" height="${rowHeight - 20}" 
            class="task-margin stroke-b${task.block}" 
            onmouseover="showTooltip(evt, '${tipMargin}')" onmouseout="hideTooltip()" />`;

        // Dependencias
        task.dep.forEach(depId => {
            const depIndex = tasks.findIndex(t => t.id === depId);
            if (depIndex !== -1) {
                const depS = schedule[depId];
                // La flecha sale del final del margen de la tarea previa
                const startX = leftPadding + (depS.EF * dayWidth); 
                const startY = currentY - (index - depIndex) * rowHeight + (rowHeight/2);
                const endX = xBase; 
                const endY = currentY + (rowHeight/2);
                
                let path = "";
                if (endX > startX + 10) {
                     path = `M ${startX} ${startY} L ${endX - 5} ${startY} L ${endX - 5} ${endY} L ${endX} ${endY}`;
                } else {
                     path = `M ${startX} ${startY} L ${startX + 5} ${startY} L ${startX + 5} ${endY - 5} L ${endX - 5} ${endY - 5} L ${endX - 5} ${endY} L ${endX} ${endY}`;
                }
                linesHTML += `<path d="${path}" class="dependency-line" />`;
            }
        });

        currentY += rowHeight;
    });

    svgHTML += `<line x1="0" y1="${currentY}" x2="${svgWidth}" y2="${currentY}" class="row-separator" />`;
    
    // Ensamblaje final (Orden de capas importa)
    svgHTML += blockHTML + linesHTML + taskBarsHTML + textHTML + `</svg>`;
    document.getElementById('chart-container').innerHTML = svgHTML;

    // Tooltip Logic
    const tooltip = document.getElementById('tooltip');
    window.showTooltip = (evt, text) => {
        tooltip.innerHTML = text;
        tooltip.style.opacity = 1;
        let left = evt.pageX + 15;
        if (left + 250 > window.innerWidth) left = evt.pageX - 260;
        tooltip.style.left = left + 'px';
        tooltip.style.top = (evt.pageY + 10) + 'px';
    };
    window.hideTooltip = () => { tooltip.style.opacity = 0; };
</script>
</body>
</html>
